# Ferric Substitution Tools for Silicate Minerals

This repository provides a suite of Python tools for modeling charge-coupled ferric substitution mechanisms in Fe-bearing silicate minerals, especially those represented by Special Quasirandom Structures (SQS) generated by the [ATAT toolkit](https://www.brown.edu/Departments/Engineering/Labs/avdw/atat/). The core functionality includes introducing Fe<sup>3+</sup> via two types of charge-coupled substitutions, coordinate conversion utilities, and structure deduplication tools. They have been tested to work well for both bridgmanite and post-perovskite.

---

## Repository Structure

```
.
├── src/              # Core source code
│   ├── intro_ferric.py     # Main substitution tool
│   ├── c2d.py              # Coordinate conversion helper
│   └── deduplication.py    # Structure deduplication script
├── example/          # Example input/output
│   ├── FeAl/
│   ├── FeFe/
│   └── dedup/
```

---

## Overview of Tools

### `intro_ferric.py`: Ferric Substitution Generator

This script introduces ferric iron (Fe<sup>3+</sup>) into a supercell containing ferrous iron (Fe<sup>2+</sup>) via **charge-coupled substitution mechanisms**, following two possible reactions:

* **Mg<sup>2+</sup> + Si<sup>4+</sup> → Al<sup>3+</sup> + Fe<sup>3+</sup>**  (Fe-Al pair)
* **Mg<sup>2+</sup> + Si<sup>4+</sup> → Fe<sup>3+</sup> + Fe<sup>3+</sup>**  (Fe-Fe pair)

#### Requirements:

* Input structure should be in VASP `POSCAR` format.
* It's recommended to use SQS structures generated by ATAT, where Fe randomly substitutes Mg.
* POSCAR lines may optionally include comments starting with `!` to denote atom identities.

#### Key Substitution Rules:

1. **Nearest-neighbor rule**: The ions involved in charge-coupled substitution must be nearest neighbors to minimize local potential energy.
2. **Avoid Fe sharing one Fe<sup>3+</sup>/Al<sup>3+</sup> neighbor**: Prevents unintended Fe<sup>2.5+</sup> configurations due to delocalized charges in DFT.
3. **Avoid Al/Fe<sup>3+</sup> sharing one Fe neighbor**: Prevents unrealistic clustering of highly charged ions.

The algorithm finds Si atoms with two nearby Fe neighbors, evaluates all possible substitutions, and writes out a modified structure file (in direct coordinates) with annotated replacements. Filtering is applied based on nearest and second-nearest neighbor distances.

### `c2d.py`: Coordinate Conversion Utility

A helper module for reading and converting `POSCAR`-like files between **Cartesian** and **Direct** (fractional) coordinate systems. It exports the following:

* `read_poscar`: reads POSCAR file into structured dictionary
* `cartesian_to_fractional`: converts Cartesian → Direct
* `fractional_to_cartesian`: converts Direct → Cartesian
* `write_poscar`: writes updated POSCAR with new coordinates

Used internally by `intro_ferric.py` and `deduplication.py` to ensure consistent coordinate handling.

### `deduplication.py`: Structure Deduplication by Fe-Fe Fingerprints

Given a directory of `.vasp` files with different Fe distributions, this tool removes redundant structures based on a **fingerprint of all pairwise Fe-Fe distances**:

* Structures with nearly identical Fe-Fe distance distributions (within tolerance) are considered duplicates.
* Configurations are compared in a pairwise manner, and only unique structures (based on a threshold similarity score) are retained.
* Deduplicated files are copied to a new `selected/` directory.

This is particularly useful when exploring many random Fe distributions generated by SQS for one cell size and composition.

---

## Example Directory

The `example/` folder includes three ready-to-run test cases:

### `FeAl/`: Fe-Al charge-coupled substitution (Fe<sup>3+</sup>/ΣFe = 0.5)

```bash
python3 ../../src/intro_ferric.py -s -rs 20250505
```

### `FeFe/`: Fe-Fe charge-coupled substitution (4 pairs introduced)

```bash
python3 ../../src/intro_ferric.py -s -rs 20250505 -c Fe -n 4
```

### `dedup/`: Fingerprint-based deduplication of multiple structures

```bash
python3 ../../src/deduplication.py ./sample
```

---

## License

This project is released under the MIT License.

---

## Contact

For questions, suggestions, or collaboration, please contact:  
**Yihang Peng**  
Ph.D. Candidate 
Deng Research Group | Department of Geosciences  
308A Guyot Hall  
Princeton University  
Princeton, NJ 08544, USA  
Email: yhpeng@princeton.edu  
